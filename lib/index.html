<!doctype html>

<title>Playground</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    * {
        box-sizing: border-box;
        font-size: 14px;
    }
    html, body {
        height: 100%;
        margin: 0;
    }
    #code {
        height: 100%;
        width: 100%;
        border: none;
        background-color: transparent;
        resize: none;
    }
    #input {
        position:absolute;
        left:0;
        top:32px;
        width:100%;
        bottom:33%;
    }
    #output {
        position: absolute;
        width: 100%;
        top: 67%;
        bottom: 0;
        overflow-y: scroll;
    }
    #output div {
        white-space: pre-wrap;
        word-break: break-all;
        padding: 0.2em 0.5em;
    }
    #output div.title {
        font-size: 90%;
        background: #eee;
    }
    #output div.content {
        font-family: monospace;
        padding: 0.5em;
    }
</style>

<body>
  <div style="position:relative;height:100%">
    <div style="line-height: 32px;height:32px;padding:0 0.5em">
	<button onclick="run()">Run (F5)</button>
	<span style="float:right">
	    <a href="https://github.com/coyove/script">Github</a>
	</span>
    </div>
    <div id="input">
	<div style="border:solid 1px #aaa;border-width:1px 0 1px 0;height:100%;background: #ffc;">
	    <textarea id="code">-- Author: coyove
_, author = re([[Author: (\S+)]]).find(SOURCE_CODE)
println("Author is:", author)

-- Print all global values, mainly functions
-- use doc(function) to view its documentation
local g = debug.globals()

print(("version %s, total global values: %d").format(VERSION, #g/3))

function pp(name, f, ident)
    if type(f) == "object" then
        if f.iscallable() then
            local d = f.doc()
            print(ident, name, " ", d.trimleft(name))
            print()
        end
        for k, v in f do pp(name + "." + str(k), v, ident) end
    else
        print(ident, name, "=", f)
        print()
    end		
end

for i=0,len(g),3 do
    if g[i+1] == '' then
    else
        local name = g[i + 1]
        if len(name) > 32 then
            name = name.sub(0, 16) + '...' + name.sub(#name-16, #name)
        end
        pp(i//3 + ": " + name, g[i + 2], "")
    end
end</textarea>
	</div>
    </div>
    <div id="output"></div>
  </div>
</body>

<script>
    var output = document.getElementById("output"), editor = document.getElementById('code');
    editor.addEventListener('keydown', function(e) {
        var start = this.selectionStart, end = this.selectionEnd;
        if (e.key == 'Tab') {
            e.preventDefault();
            this.value = this.value.substring(0, start) + "\t" + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
        }
        if (e.key == 'F5') {
            e.preventDefault();
            run();
        }
        if (e.key == 'Enter') {
            var v = this.value.substring(0, start);
            var idx = v.lastIndexOf('\n');
            if (idx) {
                v = v.substring(idx + 1)
                var spaces = '';
                for (var i = 0; i < v.length; i++) {
                    var c = v.charAt(i);
                    if (c == ' ' || c == '\t') 
                        spaces += c;
                    else
                        break;
                }
                if (spaces) {
                    e.preventDefault()
                    this.value = this.value.substring(0, start) + "\n" + spaces + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 1 + spaces.length;
                }
            }
        }
    });

    function div(html, title) {
        var el = document.createElement("div");
        el.className = title ? 'title' : 'content';
        el.innerText = html;
        return el;
    }

    function run() {
        fetch('?code=' + encodeURIComponent(editor.value))
        .then(response => response.json())
        .then(function(data) {
            var el = output;
            el.innerHTML = '';

            if (data.error) {
                el.appendChild(div("Error", true))
                el.appendChild(div(data.error))
            } else if (data.result) {
                el.appendChild(div("Results", true))
                v = data.result;
                el.appendChild(div(typeof v === 'object' ? JSON.stringify(v) : v));
            }
            if (data.stdout) {
                el.appendChild(div("Stdout", true));
                el.appendChild(div(data.stdout));
                el.appendChild(div("Elapsed", true))
                el.appendChild(div(data.elapsed + 's'));
            }
            if (data.opcode) {
                el.appendChild(div("Compiled", true));
                el.appendChild(div(data.opcode));
            }
            if (data.survey) {
                el.appendChild(div("Survey", true));
                el.appendChild(div(JSON.stringify(data.survey)));
            }
        });
    }
</script>
